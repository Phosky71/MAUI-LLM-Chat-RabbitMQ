<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:MAUILLMChatRabbitMQ.Converters"
             x:Class="MAUILLMChatRabbitMQ.Views.MainPage"
             Title="ðŸ’¬ Chat LLM"
             BackgroundColor="#F5F5F7">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:MessageTypeToColorConverter x:Key="MessageTypeToColorConverter"/>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, *, Auto">

        <!-- ===== 1. CABECERA (Header) ===== -->
        <Grid Grid.Row="0" 
              BackgroundColor="#512BD4"
              Padding="20,15,20,25"
              ColumnDefinitions="*, Auto">

            <!-- TÃ­tulo y Estado -->
            <VerticalStackLayout Grid.Column="0" Spacing="5">
                <Label Text="Sala de Chat IA" 
                       FontSize="22" 
                       FontAttributes="Bold" 
                       TextColor="White"/>

                <HorizontalStackLayout Spacing="8">
                    <Frame Padding="8,2" BackgroundColor="#6F42C1" CornerRadius="10" HasShadow="False" BorderColor="Transparent">
                        <Label Text="{Binding StatusMessage}" FontSize="12" TextColor="White"/>
                    </Frame>
                    <Label Text="{Binding MessageCount, StringFormat='â€¢ {0} msgs'}" 
                           FontSize="12" 
                           TextColor="#E0E0E0" 
                           VerticalOptions="Center"/>
                </HorizontalStackLayout>
            </VerticalStackLayout>

            <!-- BotÃ³n ConfiguraciÃ³n -->
            <Frame Grid.Column="1" 
                   WidthRequest="45" HeightRequest="45" 
                   CornerRadius="22" 
                   BackgroundColor="White" 
                   Padding="0"
                   HasShadow="False">
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnConfigClicked"/>
                </Frame.GestureRecognizers>
                <Label Text="âš™ï¸" 
                       HorizontalOptions="Center" 
                       VerticalOptions="Center" 
                       FontSize="20"/>
            </Frame>
        </Grid>

        <!-- Fondo decorativo curvado para la cabecera -->
        <BoxView Grid.Row="0" 
                 VerticalOptions="End" 
                 HeightRequest="20" 
                 Color="#F5F5F7" 
                 CornerRadius="20,20,0,0" 
                 Margin="0,-20,0,0"/>


        <!-- ===== 2. LISTA DE MENSAJES ===== -->
        <CollectionView Grid.Row="1" 
                        ItemsSource="{Binding Messages}"
                        x:Name="MessagesCollectionView"
                        ItemsLayout="VerticalList"
                        ItemsUpdatingScrollMode="KeepLastItemInView" 
                        SelectionMode="None"
                        Margin="0,0,0,10">

            <CollectionView.Header>
                <BoxView HeightRequest="10" Color="Transparent"/>
            </CollectionView.Header>

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Grid Padding="15,5">
                        <Frame BackgroundColor="{Binding MessageType, Converter={StaticResource MessageTypeToColorConverter}}"
                               CornerRadius="15"
                               Padding="15,10"
                               HasShadow="True"
                               BorderColor="Transparent">

                            <VerticalStackLayout Spacing="4">
                                <!-- Metadatos del Mensaje -->
                                <Grid ColumnDefinitions="*, Auto">
                                    <Label Text="{Binding Sender}" 
                                           FontSize="11" 
                                           FontAttributes="Bold"
                                           TextColor="#444"
                                           Opacity="0.8"/>

                                    <Label Grid.Column="1" 
                                           Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}" 
                                           FontSize="10" 
                                           TextColor="#666"/>
                                </Grid>

                                <!-- Separador sutil -->
                                <BoxView HeightRequest="1" Color="Black" Opacity="0.05" Margin="0,2,0,5"/>

                                <!-- Contenido del Mensaje -->
                                <Label Text="{Binding Content}" 
                                       FontSize="15" 
                                       TextColor="#333"
                                       LineHeight="1.2"/>
                            </VerticalStackLayout>
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <!-- Estado VacÃ­o -->
            <CollectionView.EmptyView>
                <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="20" Opacity="0.6">
                    <Label Text="ðŸ’¬" FontSize="80" HorizontalOptions="Center"/>
                    <Label Text="La conversaciÃ³n estÃ¡ vacÃ­a" FontSize="18" FontAttributes="Bold" TextColor="Gray" HorizontalOptions="Center"/>
                    <Label Text="Conecta las IAs para empezar el debate" FontSize="14" TextColor="Gray" HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </CollectionView.EmptyView>
        </CollectionView>

        <!-- Indicador Flotante de 'Procesando' -->
        <Frame Grid.Row="1" 
               VerticalOptions="Start" HorizontalOptions="Center"
               BackgroundColor="#FFF3CD" BorderColor="#FFC107"
               CornerRadius="20" Padding="15,8" Margin="0,10,0,0"
               IsVisible="{Binding IsProcessing}"
               HasShadow="True">
            <HorizontalStackLayout Spacing="8">
                <ActivityIndicator IsRunning="True" Color="#856404" WidthRequest="15" HeightRequest="15"/>
                <Label Text="La IA estÃ¡ escribiendo..." TextColor="#856404" FontSize="12" FontAttributes="Bold"/>
            </HorizontalStackLayout>
        </Frame>

        <!-- ===== 3. PANEL DE CONTROL (Corregido con Border) ===== -->
        <!-- Cambiado Frame por Border para permitir esquinas individuales -->
        <Border Grid.Row="2" 
                BackgroundColor="White" 
                StrokeThickness="0"
                StrokeShape="RoundRectangle 25,25,0,0"
                Padding="20,25,20,20">

            <Border.Shadow>
                <Shadow Brush="Black" Offset="0,-5" Radius="10" Opacity="0.1"/>
            </Border.Shadow>

            <VerticalStackLayout Spacing="15">

                <!-- Botones Principales (Start/Stop) -->
                <!-- Corregido: Shadow usa 'Brush' en vez de 'Color' -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                    <Button Grid.Column="0"
                            Text="â–¶ï¸ Iniciar"
                            Command="{Binding StartConversationCommand}"
                            BackgroundColor="#28a745"
                            TextColor="White"
                            FontAttributes="Bold"
                            CornerRadius="12"
                            HeightRequest="50"
                            Shadow="{Shadow Radius=4, Offset='0,2', Brush='#28a745', Opacity=0.3}"/>

                    <Button Grid.Column="1"
                            Text="â¹ï¸ Detener"
                            Command="{Binding DisconnectCommand}"
                            BackgroundColor="#dc3545"
                            TextColor="White"
                            FontAttributes="Bold"
                            CornerRadius="12"
                            HeightRequest="50"
                            Shadow="{Shadow Radius=4, Offset='0,2', Brush='#dc3545', Opacity=0.3}"/>
                </Grid>

                <!-- Botones Secundarios (Herramientas) -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                    <Button Grid.Column="0"
                            Text="Limpiar Chat"
                            Command="{Binding ClearMessagesCommand}"
                            BackgroundColor="#F0F0F0"
                            TextColor="#333"
                            FontSize="13"
                            CornerRadius="8"
                            HeightRequest="40"/>

                    <Button Grid.Column="1"
                            Text="Borrar Memoria"
                            Command="{Binding ClearHistoryCommand}"
                            BackgroundColor="#F0F0F0"
                            TextColor="#333"
                            FontSize="13"
                            CornerRadius="8"
                            HeightRequest="40"/>
                </Grid>

            </VerticalStackLayout>
        </Border>

    </Grid>
</ContentPage>
